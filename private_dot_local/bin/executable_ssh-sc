#!/usr/bin/env bash

POSSIBLE_PATHS=(
  /usr/local/lib/ssh-keychain-stub.dylib # https://github.com/liamdawson/ssh-keychain-stub/
  /usr/lib/ssh-keychain.dylib
  /usr/local/lib/opensc-pkcs11.so
  /usr/lib/x86_64-linux-gnu/opensc-pkcs11.so
)

add_lib() {
  lib="$1"
  bash -xc "ssh-add -s '$lib'"
}

for path_option in "${POSSIBLE_PATHS[@]}"; do
  if [ -r "$path_option" ]; then
    add_lib "$path_option"
    exit $?
  fi
done

echo "ERROR: No expected pkcs11 libs found"
exit 127
