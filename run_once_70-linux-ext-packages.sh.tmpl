#!/usr/bin/env bash

set -Eeuo pipefail

## {{ if eq .chezmoi.os "linux" }}

main() {
  install_apt_packages
}

install_apt_packages() {
  local packages=(
    1password
    code
    containerd.io
    docker-ce
    docker-ce-cli
    docker-compose
    fish
    google-chrome-stable
  )

  local distro_codename && distro_codename="$(lsb_release --short --codename)"

  if ! [ -f "/usr/share/keyrings/1password.gpg" ]; then
    sudo apt-key --keyring "/usr/share/keyrings/1password.gpg" adv --keyserver "keyserver.ubuntu.com" --recv-keys "3FEF9748469ADBE15DA7CA80AC2D62742012EA22"
  fi

  if ! [ -f "/etc/apt/sources.list.d/1password.list" ]; then
    echo 'deb [arch=amd64 signed-by=/usr/share/keyrings/1password.gpg] https://downloads.1password.com/linux/debian edge main' | sudo tee /etc/apt/sources.list.d/1password.list
  fi

  if ! [ -f /usr/share/keyrings/packages.microsoft.gpg ]; then
    curl https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor >packages.microsoft.gpg
    sudo install -o root -g root -m 644 packages.microsoft.gpg /usr/share/keyrings/
  fi

  if ! [ -f /etc/apt/sources.list.d/vscode.list ]; then
    sudo sh -c 'echo "deb [arch=amd64 signed-by=/usr/share/keyrings/packages.microsoft.gpg] https://packages.microsoft.com/repos/code stable main" > /etc/apt/sources.list.d/vscode.list'
  fi

  if ! [ -f "/etc/apt/sources.list.d/fish-shell-ubuntu-release-3-${distro_codename}.list" ]; then
    sudo add-apt-repository --yes ppa:fish-shell/release-3
  fi

  if ! [ -f "/etc/apt/sources.list.d/docker.list" ]; then
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
    sudo sh -c 'echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" > /etc/apt/sources.list.d/docker.list'
  fi

  if ! [ -f "/etc/apt/sources.list.d/google-linux.list" ]; then
    curl -fsSL https://dl.google.com/linux/linux_signing_key.pub | sudo gpg --dearmor -o /usr/share/keyrings/google-linux-keyring.gpg
    sudo sh -c 'echo "deb [arch=amd64 signed-by=/usr/share/keyrings/google-linux-keyring.gpg] http://dl.google.com/linux/chrome/deb/ stable main" > /etc/apt/sources.list.d/google-linux.list'
  fi

  sudo apt-get update
  sudo apt-get install -y "${packages[@]}"
}

main

## {{ end }}
