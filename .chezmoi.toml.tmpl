{{- $workMachine := promptBoolOnce . "workMachine" "Is this a work machine?" }}
{{- $personalMachine := promptBoolOnce . "personalMachine" "Is this a personal machine?" }}
{{- $personalEmail := promptStringOnce . "emailPersonal" "Personal email address" }}
{{- $pushoverUserKey := promptStringOnce . "pushoverUserKey" "Pushover User key" }}
{{- $pushoverApiKey := promptStringOnce . "pushoverApiKey" "Pushover API key" }}
{{- $envatoEmail := "" }}

{{- if eq $workMachine true }}
{{-   $envatoEmail = promptStringOnce . "emailEnvato" "Envato email address" }}
{{- end }}

{{- $homebrewPrefix := "/home/linuxbrew/.linuxbrew" }}
{{- if eq .chezmoi.os "darwin" }}
{{-   $homebrewPrefix = "/opt/homebrew" }}
{{- end }}

{{- $homebrewBinPath := joinPath $homebrewPrefix "bin" }}

{{- $chassisType := "desktop" }}
{{- if eq .chezmoi.os "darwin" }}
{{-   if contains "MacBook" (output "sysctl" "-n" "hw.model") }}
{{-     $chassisType = "laptop" }}
{{-   else }}
{{-     $chassisType = "desktop" }}
{{-   end }}
{{- else if eq .chezmoi.os "linux" }}
{{-   $chassisType = (output "hostnamectl" "--json=short" | mustFromJson).Chassis }}
{{- end -}}

{{- $osid := .chezmoi.os }}
{{- if hasKey .chezmoi.osRelease "id" }}
{{-   $osid = printf "%s-%s" .chezmoi.os .chezmoi.osRelease.id }}
{{- end -}}

{{- $cpuCores := 1 }}
{{- $cpuThreads := 1 }}
{{- if eq .chezmoi.os "darwin" }}
{{-   $cpuCores = (output "sysctl" "-n" "hw.physicalcpu_max") | trim | atoi }}
{{-   $cpuThreads = (output "sysctl" "-n" "hw.logicalcpu_max") | trim | atoi }}
{{- else if eq .chezmoi.os "linux" }}
{{-   $cpuCores = (output "sh" "-c" "lscpu --online --parse | grep --invert-match '^#' | sort --field-separator=',' --key='2,4' --unique | wc --lines") | trim | atoi }}
{{-   $cpuThreads = (output "sh" "-c" "lscpu --online --parse | grep --invert-match '^#' | wc --lines") | trim | atoi }}
{{- end -}}

{{- $totalMem := 1 }}
{{- if eq .chezmoi.os "darwin" }}
{{-   $totalMem = (output "bash" "-c" "echo $(($(sysctl -n hw.memsize) / 1024 / 1024 / 1024))") | trim | atoi }}
{{- else if eq .chezmoi.os "linux" }}
{{-   $totalMem = (output "sh" "-c" "awk '/MemTotal/ { printf \"%.0f \n\", $2/1024/1024 }' /proc/meminfo") | trim | atoi }}
{{- end -}}

[age]
	identity = "~/.config/chezmoi/age.key"
	recipient = "age16650awzwppw8s725pvj8k32nfccyvgssvw5qj2kq9a9tsyxuyspsy7npy5"

[data]
	editor = {{ joinPath $homebrewBinPath "vim" | quote }}
	emailEnvato = {{ $envatoEmail | quote }}
	emailPersonal = {{ $personalEmail | quote }}
	gitSigningKey = "0xA0BE84DBE2E93076"
	gpgDefaultKey = "0xA0BE84DBE2E93076"
	gpgPinentry = {{ joinPath $homebrewBinPath "pinentry-mac" | quote }}
	gpgTrustedKey = "0xA0BE84DBE2E93076"
	personalMachine = {{ $personalMachine }}
	pushoverApiKey = {{ $pushoverApiKey | quote }}
	pushoverUserKey = {{ $pushoverUserKey | quote }}
	sshPkcs11Provider = "/usr/lib/ssh-keychain.dylib"
	visualEditor = {{ printf "%s -w" (joinPath $homebrewBinPath "code") | quote }}
	workMachine = {{ $workMachine }}

	[data.homebrew]
		prefix = {{ $homebrewPrefix | quote }}
		bin = {{ $homebrewBinPath | quote }}

	[data.machine]
		chassisType = {{ $chassisType | quote }}
		cpuCores = {{ $cpuCores }}
		cpuThreads = {{ $cpuThreads }}
		osid = {{ $osid | quote }}
		totalMem = {{ $totalMem }}
